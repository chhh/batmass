<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <title>Parsing pep.xml files - BatMass</title>
    <meta name="generator" content="Hugo 0.40.3" />

    
    <meta name="description" content="Mass spectrometry data visualization">
    
    <link rel="canonical" href="http://batmass.org/tutorial/parsing-pep-ids/">
    
    <meta name="author" content="Dmitry Avtonomov">
    

    <meta property="og:url" content="http://batmass.org/tutorial/parsing-pep-ids/">
    <meta property="og:title" content="BatMass">
    <meta property="og:image" content="http://batmass.org/images/bm-icon-512.png">
    <meta name="apple-mobile-web-app-title" content="BatMass">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://batmass.org/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://batmass.org/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://batmass.org/fonts/icon.eot?52m981');
        src: url('http://batmass.org/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
             url('http://batmass.org/fonts/icon.woff?52m981')
               format('woff'),
             url('http://batmass.org/fonts/icon.ttf?52m981')
               format('truetype'),
             url('http://batmass.org/fonts/icon.svg?52m981#icon')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>



    <link rel="stylesheet" href="http://batmass.org/stylesheets/application.css">
    <link rel="stylesheet" href="http://batmass.org/stylesheets/palettes.css">


    
    
    
      <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/agate.min.css">
    

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu%2bMono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <link rel="stylesheet" href="http://batmass.org//css/batmass.css">
    
    <link rel="stylesheet" href="http://batmass.org//css/more-colors.css">
    
    <script src="http://batmass.org/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-teal palette-accent-indigo">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Parsing pep.xml files
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/chhh" title="@chhh on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/chhh/batmass" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://batmass.org/images/bm-icon-512.png">
        </div>
      
      <div class="name">
        <strong>BatMass <span class="version">0.3.0</span></strong>
        
          <br>
          chhh/batmass
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/chhh/batmass/releases/latest" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/chhh/batmass/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          





<li>
  
    



<a  title="BatMass" href="http://batmass.org/">
	
	BatMass
</a>



  
</li>




<li>
  
    



<a  title="Getting started" href="http://batmass.org/getting-started/">
	
	Getting started
</a>



  
</li>




<li>
  
    



<a  title="MSFTBX: Data Access Library" href="http://batmass.org/data-access-lib/">
	
	MSFTBX: Data Access Library
</a>



  
</li>




<li>
  
    



<a  title="Contact info" href="http://batmass.org/contacts/">
	
	Contact info
</a>



  
</li>




<li>
  

  



<a  title="Tutorials" href="http://batmass.org/tutorial/">
	
	Tutorials
</a>




  <li>
    

    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    


    <ul>
      
        
        



<a  title="Data access library (LC/MS files and simple Peptide ID examples)" href="http://batmass.org/tutorial/data-access-layer/">
	
	Data access library (LC/MS files and simple Peptide ID examples)
</a>



      
        
        



<a class="current" title="Parsing pep.xml files" href="http://batmass.org/tutorial/parsing-pep-ids/">
	
	Parsing pep.xml files
</a>


<ul id="scrollspy">
</ul>


      
        
        



<a  title="Overlay peptide IDs on 2D map" href="http://batmass.org/tutorial/overlay-peptide-ids-on-map2d/">
	
	Overlay peptide IDs on 2D map
</a>



      
        
        



<a  title="Display custom data on 2D map" href="http://batmass.org/tutorial/custom-drawing/">
	
	Display custom data on 2D map
</a>



      
        
        



<a  title="Setting up development environment" href="http://batmass.org/tutorial/setting-up-development-environment/">
	
	Setting up development environment
</a>



      
        
        



<a  title="Developing the first plugin" href="http://batmass.org/tutorial/developing-first-plugin/">
	
	Developing the first plugin
</a>



      
    </ul>
  
</li>




<li>
  
    



<a  title="License" href="http://batmass.org/license/">
	
	License
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">Dmitry Avtonomov</span>

        <ul>
          

          
          <li>
            <a href="https://github.com/chhh" target="_blank" title="@chhh on GitHub">
              @chhh on GitHub
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">

			

			<h1>Parsing pep.xml files </h1>

			

<p>All the classes responsible for parsing files live in <code>umich.ms.fileio.filetypes</code> package, each in its own subpackage, e.g. <code>umich.ms.fileio.filetypes.pepxml</code> for PepXML files. Most of those sub-packages contain a separate package <code>example</code> with working examples.</p>

<h2 id="parsing-identification-files-pepxml-protxml-mzidentml">Parsing identification files (PepXML, ProtXML, MzIdentML)</h2>

<p>The library gives low level access file formats storing peptide identifications.
There is no unifying API here, as the formats are very different. These parsers are not hand optimized for efficiency, so they might consume quite a bit more memory than they should, but they also are error resilient.</p>

<p>Working with these files is as simple as making a single call to <code>parse(Path)</code> method
of a corresponding parser. You get a single data-structure that follows the respective
XML schemas for the format. Here&rsquo;s a quick PepXML example:</p>

<pre><code class="language-java">Path path = Paths.get(&quot;some-path-to.pep.xml&quot;);
// a single call to parse the whole file
MsmsPipelineAnalysis analysis = PepXmlParser.parse(path);
</code></pre>

<p>And that&rsquo;s it. The whole file is parsed and stored in memory. Let&rsquo;s explore
the contents of the file:</p>

<pre><code class="language-java">// iterate over the parsed search results
List&lt;MsmsRunSummary&gt; runSummaries = analysis.getMsmsRunSummary();
for (MsmsRunSummary runSummary : runSummaries) {
    List&lt;SpectrumQuery&gt; spectrumQueries = runSummary.getSpectrumQuery();
    System.out.printf(&quot;Spectrum queries from MS/MS run summary: %s\n&quot;,
                      runSummary.getBaseName());
    for (SpectrumQuery sq : spectrumQueries) {
        System.out.printf(&quot;Spec ID: [%s], RT: [%.2f], precursor neutral mass: [%.3f]\n&quot;,
                          sq.getSpectrum(), sq.getRetentionTimeSec(), sq.getPrecursorNeutralMass());
    }
    System.out.printf(&quot;Done with MS/MS run summary: %s\n&quot;, runSummary.getBaseName());
}
</code></pre>

<h2 id="parsing-huge-identification-files-more-efficiently">Parsing huge identification files more efficiently</h2>

<p>Sometimes you might have PepXML files that are many gigabytes in size. This happens when you combine search results from multiple experiments and store them in a single output file. In that case, using <code>XMLStreamReader</code> class it is possible to first rewind the input stream to some large structural element of the underlying file, such as <code>&lt;msms_run_summary&gt;</code> in PepXML files.<br />
You will need to have an idea of how the files are organized for this to work in general though, explore the corresponding XML schemas for insights. The schemas can also be found in the sources of the library in file-specific sub-packages of <code>umich.ms.fileio.filetypes</code> in <code>resources</code> directories.</p>

<pre><code class="language-java">String file = &quot;/path/to/some.pep.xml&quot;;
Path path = Paths.get(file);

try (FileInputStream fis = new FileInputStream(file)) {
    // we'll manually iterate over msmsRunSummaries - won't need so much memory
    // at once for processing large files.
    JAXBContext ctx = JAXBContext.newInstance(MsmsRunSummary.class);
    Unmarshaller unmarshaller = ctx.createUnmarshaller();

    XMLInputFactory xif = XMLInputFactory.newFactory();

    StreamSource ss = new StreamSource(fis);
    XMLStreamReader xsr = xif.createXMLStreamReader(ss);


    while (advanceReaderToNextRunSummary(xsr)) {
        // we've advanced to the next MsmsRunSummary in the file
        long timeLo = System.nanoTime();
        JAXBElement&lt;MsmsRunSummary&gt; unmarshalled = unmarshaller
                .unmarshal(xsr, MsmsRunSummary.class);
        long timeHi = System.nanoTime();
        System.out.printf(&quot;Unmarshalling took %.4fms (%.2fs)\n&quot;,
                          (timeHi-timeLo)/1e6, (timeHi-timeLo)/1e9);
        MsmsRunSummary runSummary = unmarshalled.getValue();
        if (runSummary.getSpectrumQuery().isEmpty()) {
            String msg = String.format(&quot;Parsed msms_run_summary was empty for &quot; +
                        &quot;'%s', summary base_name '%s'&quot;,
                        path.toUri().toString(), runSummary.getBaseName());
            System.out.println(msg);
        }
    }
}
</code></pre>

<p>The secret ingredient here is the code to rewind the <code>XMLStreamReader</code>, the <code>advanceReaderToNextRunSummary(XMLStreamReader)</code> method.
In this case the example assumes we try to parse multiple msms_run_summary tags one by one from the file.</p>

<pre><code class="language-java">private static boolean advanceReaderToNextRunSummary(XMLStreamReader xsr)
    throws XMLStreamException {
  do {
      if (xsr.next() == XMLStreamConstants.END_DOCUMENT)
          return false;
  } while (!(xsr.isStartElement() &amp;&amp; xsr.getLocalName().equals(&quot;msms_run_summary&quot;)));

  return true;
}
</code></pre>

<p>And here are all the import statements for the last example:</p>

<pre><code class="language-java">import umich.ms.fileio.filetypes.pepxml.PepXmlParser;
import umich.ms.fileio.filetypes.pepxml.jaxb.standard.MsmsPipelineAnalysis;
import umich.ms.fileio.filetypes.pepxml.jaxb.standard.MsmsRunSummary;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBElement;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Unmarshaller;
import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;
import javax.xml.stream.XMLStreamReader;
import javax.xml.transform.stream.StreamSource;
import java.io.FileInputStream;
import java.nio.file.Path;
import java.nio.file.Paths;
</code></pre>


			<aside class="copyright" role="note">
				
				&copy; 2018 Dmitry Avtonomov. Released under the Apache 2.0 license. &ndash;
				
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://batmass.org/tutorial/data-access-layer/" title="Data access library (LC/MS files and simple Peptide ID examples)">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Data access library (LC/MS files and simple Peptide ID examples)
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://batmass.org/tutorial/overlay-peptide-ids-on-map2d/" title="Overlay peptide IDs on 2D map">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Overlay peptide IDs on 2D map
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'http:\/\/batmass.org\/';
      var repo_id  = 'chhh\/batmass';
    
    </script>

    <script src="http://batmass.org/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(headers.length > 0) {
        for(var i = 0; i < headers.length; i++) {
          var li = document.createElement("li");
          li.setAttribute("class", "anchor");

          var a  = document.createElement("a");
          a.setAttribute("href", "#" + headers[i].id);
          a.setAttribute("title", headers[i].innerHTML);
          a.innerHTML = headers[i].innerHTML;

          li.appendChild(a)
          scrollspy.appendChild(li);
        }
      } else {
        scrollspy.parentElement.removeChild(scrollspy)
      }


      /* Add permanent link next to the headers */
      var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

      for(var i = 0; i < headers.length; i++) {
          var a = document.createElement("a");
          a.setAttribute("class", "headerlink");
          a.setAttribute("href", "#" + headers[i].id);
          a.setAttribute("title", "Permanent link")
          a.innerHTML = "#";
          headers[i].appendChild(a);
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-5572974-10', 'auto');
        
        ga('send', 'pageview');


        
        
        
        
        
        
        

         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    

    
    
    
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

